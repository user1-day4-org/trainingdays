<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>💎 Challenge 3: Azure AD applications and deployment to GitHub environments 💎 | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.8d7a09fd.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.b4a8c541.js" as="script"><link rel="preload" href="/trainingdays/assets/js/3.da874b83.js" as="script"><link rel="preload" href="/trainingdays/assets/js/33.39efcbb5.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.e44c6d2b.js"><link rel="prefetch" href="/trainingdays/assets/js/11.8d5d356c.js"><link rel="prefetch" href="/trainingdays/assets/js/12.6778aae7.js"><link rel="prefetch" href="/trainingdays/assets/js/13.b0949e4a.js"><link rel="prefetch" href="/trainingdays/assets/js/14.45d2e82e.js"><link rel="prefetch" href="/trainingdays/assets/js/15.53ef245a.js"><link rel="prefetch" href="/trainingdays/assets/js/16.5219bfbe.js"><link rel="prefetch" href="/trainingdays/assets/js/17.7b5a88ba.js"><link rel="prefetch" href="/trainingdays/assets/js/18.05cc6b87.js"><link rel="prefetch" href="/trainingdays/assets/js/19.ea8f1e35.js"><link rel="prefetch" href="/trainingdays/assets/js/2.4daa04a4.js"><link rel="prefetch" href="/trainingdays/assets/js/20.799f221d.js"><link rel="prefetch" href="/trainingdays/assets/js/21.bb9bc3fb.js"><link rel="prefetch" href="/trainingdays/assets/js/22.13605d4a.js"><link rel="prefetch" href="/trainingdays/assets/js/23.38c6577b.js"><link rel="prefetch" href="/trainingdays/assets/js/24.e9097a3e.js"><link rel="prefetch" href="/trainingdays/assets/js/25.671ec9be.js"><link rel="prefetch" href="/trainingdays/assets/js/26.25214aab.js"><link rel="prefetch" href="/trainingdays/assets/js/27.cc73a3b6.js"><link rel="prefetch" href="/trainingdays/assets/js/28.8df30c80.js"><link rel="prefetch" href="/trainingdays/assets/js/29.3feafcdb.js"><link rel="prefetch" href="/trainingdays/assets/js/30.6e77cf4e.js"><link rel="prefetch" href="/trainingdays/assets/js/31.b4e755a1.js"><link rel="prefetch" href="/trainingdays/assets/js/32.072a342a.js"><link rel="prefetch" href="/trainingdays/assets/js/34.2e76bcfa.js"><link rel="prefetch" href="/trainingdays/assets/js/35.fd4cb5d8.js"><link rel="prefetch" href="/trainingdays/assets/js/36.714780e7.js"><link rel="prefetch" href="/trainingdays/assets/js/37.00437e67.js"><link rel="prefetch" href="/trainingdays/assets/js/38.b4748e29.js"><link rel="prefetch" href="/trainingdays/assets/js/39.07557fc2.js"><link rel="prefetch" href="/trainingdays/assets/js/4.8c8b7cb9.js"><link rel="prefetch" href="/trainingdays/assets/js/40.02ac8666.js"><link rel="prefetch" href="/trainingdays/assets/js/41.7bc67946.js"><link rel="prefetch" href="/trainingdays/assets/js/42.b754635d.js"><link rel="prefetch" href="/trainingdays/assets/js/43.a465c972.js"><link rel="prefetch" href="/trainingdays/assets/js/44.896d8a0c.js"><link rel="prefetch" href="/trainingdays/assets/js/45.2d998bff.js"><link rel="prefetch" href="/trainingdays/assets/js/46.e4aafd8b.js"><link rel="prefetch" href="/trainingdays/assets/js/47.7d327518.js"><link rel="prefetch" href="/trainingdays/assets/js/48.ed3347cb.js"><link rel="prefetch" href="/trainingdays/assets/js/49.555fd6a8.js"><link rel="prefetch" href="/trainingdays/assets/js/5.8f114f2e.js"><link rel="prefetch" href="/trainingdays/assets/js/50.f6cdcbe7.js"><link rel="prefetch" href="/trainingdays/assets/js/51.818186ab.js"><link rel="prefetch" href="/trainingdays/assets/js/52.1ec80ac0.js"><link rel="prefetch" href="/trainingdays/assets/js/53.705d418f.js"><link rel="prefetch" href="/trainingdays/assets/js/54.50df76f3.js"><link rel="prefetch" href="/trainingdays/assets/js/55.9f9f91d7.js"><link rel="prefetch" href="/trainingdays/assets/js/56.5e6dabe2.js"><link rel="prefetch" href="/trainingdays/assets/js/57.cae1a4f1.js"><link rel="prefetch" href="/trainingdays/assets/js/58.e94d2927.js"><link rel="prefetch" href="/trainingdays/assets/js/59.3b106e81.js"><link rel="prefetch" href="/trainingdays/assets/js/6.c5e21650.js"><link rel="prefetch" href="/trainingdays/assets/js/60.ea90d82b.js"><link rel="prefetch" href="/trainingdays/assets/js/61.113aeff3.js"><link rel="prefetch" href="/trainingdays/assets/js/62.8484b2f2.js"><link rel="prefetch" href="/trainingdays/assets/js/63.ecd38fc0.js"><link rel="prefetch" href="/trainingdays/assets/js/64.4266add8.js"><link rel="prefetch" href="/trainingdays/assets/js/65.8961eae2.js"><link rel="prefetch" href="/trainingdays/assets/js/66.c0903f34.js"><link rel="prefetch" href="/trainingdays/assets/js/67.dca24060.js"><link rel="prefetch" href="/trainingdays/assets/js/68.dbaa6d30.js"><link rel="prefetch" href="/trainingdays/assets/js/69.fabf1117.js"><link rel="prefetch" href="/trainingdays/assets/js/7.a66c3f77.js"><link rel="prefetch" href="/trainingdays/assets/js/70.de883451.js"><link rel="prefetch" href="/trainingdays/assets/js/71.c1e514c9.js"><link rel="prefetch" href="/trainingdays/assets/js/72.76864463.js"><link rel="prefetch" href="/trainingdays/assets/js/73.81e83d2f.js"><link rel="prefetch" href="/trainingdays/assets/js/74.08d88d5c.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8fb23e6c.js"><link rel="prefetch" href="/trainingdays/assets/js/76.2033e175.js"><link rel="prefetch" href="/trainingdays/assets/js/77.ebd187fd.js"><link rel="prefetch" href="/trainingdays/assets/js/78.4a8749de.js"><link rel="prefetch" href="/trainingdays/assets/js/79.f4f61312.js"><link rel="prefetch" href="/trainingdays/assets/js/8.bf08f514.js"><link rel="prefetch" href="/trainingdays/assets/js/80.b0049de9.js"><link rel="prefetch" href="/trainingdays/assets/js/81.ecf9f971.js"><link rel="prefetch" href="/trainingdays/assets/js/82.7e86df87.js"><link rel="prefetch" href="/trainingdays/assets/js/83.add51044.js"><link rel="prefetch" href="/trainingdays/assets/js/84.539663cd.js"><link rel="prefetch" href="/trainingdays/assets/js/85.96331b69.js"><link rel="prefetch" href="/trainingdays/assets/js/86.e9ee1173.js"><link rel="prefetch" href="/trainingdays/assets/js/87.8764cd2a.js"><link rel="prefetch" href="/trainingdays/assets/js/9.b0e56094.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.8d7a09fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" aria-current="page" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="💎-challenge-3-azure-ad-applications-and-deployment-to-github-environments-💎"><a href="#💎-challenge-3-azure-ad-applications-and-deployment-to-github-environments-💎" class="header-anchor">#</a> 💎 Challenge 3: Azure AD applications and deployment to GitHub environments 💎</h1> <h2 id="here-is-what-you-will-learn-🎯"><a href="#here-is-what-you-will-learn-🎯" class="header-anchor">#</a> Here is what you will learn 🎯</h2> <p>⏲️ <em>Est. time to complete: 30 min.</em> ⏲️</p> <ul><li>Create Azure AD's client and server applications to integrate Azure AD into the sample application</li> <li>Configure GitHub environments to deploy to a development and testing stage</li> <li>Deploy the shared Azure resources of the sample application</li> <li>Deploy the frontend and adjust Reply Urls</li></ul> <h2 id="table-of-content"><a href="#table-of-content" class="header-anchor">#</a> Table of content</h2> <ol><li><a href="#goal">Goal</a></li> <li><a href="#create-azure-ad-applications">Create Azure AD applications</a></li> <li><a href="#create-azure-ad-applications">Create development and test environments</a></li> <li><a href="#activate-the-cicd-workflow">Activate the CI/CD workflow</a></li> <li><a href="#summary">Summary</a></li></ol> <h2 id="goal"><a href="#goal" class="header-anchor">#</a> Goal</h2> <p>In the previous challenges you have learned some basics about the OpenID Connect
and OAuth2 flows. You have seen how you can sign in users and how to acquire an
access token for an Azure AD's protected resource. In this challenge we will
integrate Azure AD into the sample application step by step. We will use GitHub
Actions workflows to deploy the sample application to Azure. Don't worry, the
needed GitHub Actions workflows are already implemented, but we need to take
some steps to activate them.</p> <h2 id="create-azure-ad-applications"><a href="#create-azure-ad-applications" class="header-anchor">#</a> Create Azure AD applications</h2> <p>In <a href="/trainingdays/day5/challenges/02-challenge.html">Challenge 2</a> you have already seen how to create an Azure
AD client application to sign in users and how to create an API application that
exposes OAuth2 permissions. We have to do the same for the sample application.</p> <p>There is already a script available in the repository to create both
applications for you. It is located here:
<a href="https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts/aad-integration.sh" target="_blank" rel="noopener noreferrer">day5/apps/infrastructure/scripts/aad-integration.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
You need to run it in a bash/Shell environment.</p> <p>The script creates the server application first and then the client application
for the sample application. It also uses a
<a href="https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts/oauth2-permissions.json" target="_blank" rel="noopener noreferrer">oauth2-permissions.json<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
file where all needed OAuth2 permission are defined.</p> <p>After running the script twice, we registered the following applications in
Azure AD:</p> <p><img src="/trainingdays/assets/img/aad-app-registrations.c021d771.png" alt="Azure AD Application Registration"></p> <p>For each environment two applications are registered. One for the client and one
for all APIs of the sample application.</p> <h3 id="run-the-script"><a href="#run-the-script" class="header-anchor">#</a> Run the script</h3> <p>Open a shell and use Azure CLI to connect to the Azure AD Tenant where you want
to create the applications (you can also use the Azure Cloud Shell). If you have
created a new Azure AD that is not linked to an Azure subscription, add the
additional option <code>--allow-no-subscription</code>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az login --allow-no-subscription
</code></pre></div><p>You must run the script twice:</p> <ul><li>once for creating the applications for the <code>Development</code> stage</li> <li>once for creating the applications for the <code>Testing</code> stage</li></ul> <p>Use the following parameters to run the script for the <code>Development</code> stage and don't forget to replace the <code>TENANT_DOMAIN</code>:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td><em>API-APP-NAME</em></td> <td>scmapi-dev</td></tr> <tr><td><em>API-APP-URI</em></td> <td><a href="http://TENANT_DOMAIN.onmicrosoft.com/scmapi-dev" target="_blank" rel="noopener noreferrer">http://TENANT_DOMAIN.onmicrosoft.com/scmapi-dev<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td><em>UI-APP-NAME</em></td> <td>scmfe-dev</td></tr></tbody></table> <p>Use the following parameter for the <code>Testing</code> stage:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td><em>API-APP-NAME</em></td> <td>scmapi-test</td></tr> <tr><td><em>API-APP-URI</em></td> <td><a href="http://TENANT_DOMAIN.onmicrosoft.com/scmapi-test" target="_blank" rel="noopener noreferrer">http://TENANT_DOMAIN.onmicrosoft.com/scmapi-test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td><em>UI-APP-NAME</em></td> <td>scmfe-test</td></tr></tbody></table> <p>Navigate to the directory
<a href="https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts" target="_blank" rel="noopener noreferrer">day5/apps/infrastructure/scripts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> which
contains the script and the <code>oauth2-permissions.json</code> configuration file.</p> <p>Run the script twice:</p> <ul><li>once for the <code>Development</code></li> <li>once for the <code>Testing</code>stage.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 Note down the <code>UI AppId</code> and <code>API AppId</code> from the output after each run!</p></div> <div class="language-shell extra-class"><pre class="language-shell"><code>./aad-integration.sh <span class="token operator">&lt;</span>API-APP-NAME<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>API-APP-URI<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>UI-APP-NAME<span class="token operator">&gt;</span>
</code></pre></div><p>If your bash does not find jq this could help:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> jq
</code></pre></div><p>The output:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
UI AppId <span class="token keyword">for</span> app <span class="token operator">&lt;</span>UI_APP_NAME<span class="token operator">&gt;</span>: <span class="token operator">&lt;</span>please note down<span class="token operator">&gt;</span>
API AppId <span class="token keyword">for</span> app <span class="token operator">&lt;</span>API_APP_NAME<span class="token operator">&gt;</span>: <span class="token operator">&lt;</span>please note down<span class="token operator">&gt;</span>
</code></pre></div><h3 id="validate-the-applications-in-azure-ad"><a href="#validate-the-applications-in-azure-ad" class="header-anchor">#</a> Validate the Applications in Azure AD</h3> <p>After the script has been executed twice, navigate to your Azure AD and inspect
the previously created applications. You should see four new applications.</p> <h2 id="create-development-and-test-environments"><a href="#create-development-and-test-environments" class="header-anchor">#</a> Create development and test environments</h2> <p>Now it's time to prepare GitHub environments to deploy the sample application to
a <em>Dev</em> and <em>Test</em> stage for Day5 with Azure AD integration. A GitHub
environment can be configured with protection rules and secrets. A workflow job
can reference environments to use environment's protection rules and secrets.</p> <h3 id="dev-environment"><a href="#dev-environment" class="header-anchor">#</a> Dev environment</h3> <p>Let us first create the environment for the Development stage.</p> <p>Navigate to the imported <em>trainigdays</em> repository in your organization and go to
the repository's settings. Open the <em>Environments</em> view and create the
environment <code>day5-scm-dev</code>. As we only want to deploy the master branch to that
environment, we limit what branches can deploy to that environment.</p> <p>Select the <code>Deployment branches</code> dropdown and choose the <code>Selected branches</code>
option. Add the <code>master</code> branch as allowed branch.</p> <p>We need to add some secrets, which are accessed later in the GitHub Actions
workflow.</p> <p>Use the <code>Add Secret</code> button to add a new secret named <code>SQL_PASSWORD</code>.</p> <p>You can generate a strong password by using the following command:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pwgen <span class="token parameter variable">-n</span> <span class="token number">20</span> <span class="token parameter variable">-y</span>
</code></pre></div><p>Now, add the following secrets for the Azure AD integration:</p> <table><thead><tr><th>Secret name</th> <th>Value</th></tr></thead> <tbody><tr><td>AAD_API_CLIENT_ID</td> <td><em>the AppId of the Azure AD's application registration for the APIs</em></td></tr> <tr><td>AAD_API_CLIENT_ID_URI</td> <td><a href="http://scmapi-dev" target="_blank" rel="noopener noreferrer">http://scmapi-dev<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>AAD_FE_CLIENT_ID</td> <td><em>the AppId of the Azure AD's application registration for the UI client</em></td></tr> <tr><td>AAD_DOMAIN</td> <td><em>your Azure AD's domain name e.g. azuredevcollege.onmicrosoftonline.com</em></td></tr> <tr><td>AAD_INSTANCE</td> <td><a href="https://login.microsoftonline.com" target="_blank" rel="noopener noreferrer">https://login.microsoftonline.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>AAD_TENANT_ID</td> <td><em>your Azure AD's tenant or directory id</em></td></tr></tbody></table> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>⚠️ Make sure you use the values you used for the application registration script
for the development environment !</p></div> <p>At the end your secrets for the development environment looks like this:</p> <p><img src="/trainingdays/assets/img/gh-env-secrets.5c3778f5.png" alt="GitHub Dev environment config"></p> <h3 id="test-environment"><a href="#test-environment" class="header-anchor">#</a> Test environment</h3> <p>Create another environment for the Test stage and name it <code>day5-scm-test</code>. As we
want a manual approval, before a deployment is executed to that environment, we
set <em>Environment protection rules</em>. Activate <code>Required reviewers</code> and add a
reviewer.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 Add yourself as a Reviewer, otherwise you will have to wait until the
selected reviewer approves the deployment request.</p></div> <p>Make sure to again configure the selected branches and the <code>secrets</code> as following:</p> <table><thead><tr><th>Secret name</th> <th>Value</th></tr></thead> <tbody><tr><td>AAD_API_CLIENT_ID</td> <td><em>the AppId of the Azure AD's application registration for the APIs</em></td></tr> <tr><td>AAD_API_CLIENT_ID_URI</td> <td><a href="http://scmapi-test" target="_blank" rel="noopener noreferrer">http://scmapi-test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>AAD_FE_CLIENT_ID</td> <td><em>the AppId of the Azure AD's application registration for the UI client</em></td></tr> <tr><td>AAD_DOMAIN</td> <td><em>your Azure AD's domain name e.g. azuredevcollege.onmicrosoftonline.com</em></td></tr> <tr><td>AAD_INSTANCE</td> <td><a href="https://login.microsoftonline.com" target="_blank" rel="noopener noreferrer">https://login.microsoftonline.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>AAD_TENANT_ID</td> <td><em>your Azure AD's tenant or directory id</em></td></tr> <tr><td>SQL_PASSWORD</td> <td><em>your password</em></td></tr></tbody></table> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>⚠️ Make sure you use the values you used for the application registration script
for the test environment !</p></div> <h2 id="create-a-service-principal-and-store-the-secret"><a href="#create-a-service-principal-and-store-the-secret" class="header-anchor">#</a> Create a service principal and store the secret</h2> <p>To allow GitHub to interact with our Azure Subscription we need to create a
Service principal in our Azure Active Directory. If you have already created a
service principal and added it to your repository's secrets, you can skip this
step and continue with <a href="#activate-the-cicd-workflow">Activate the CI/CD
workflow</a>.</p> <p>Create a new Service Principal and copy the credentials from the output of the
following command:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Change the name and use your subscription-id to create a Service Principal.</span>
az ad sp create-for-rbac <span class="token parameter variable">--name</span> <span class="token string">&quot;{name}-github-actions-sp&quot;</span> --sdk-auth <span class="token parameter variable">--role</span> contributor <span class="token parameter variable">--scopes</span> /subscriptions/<span class="token punctuation">{</span>subscription-id<span class="token punctuation">}</span>
</code></pre></div><p>Now we need to store the Service Principal's credentials. Navigate to the
imported <em>trainingdays</em> repository <code>Settings &gt; Secrets</code>page and add a new
repository secret named <code>AZURE_CREDENTIALS</code>.</p> <h2 id="activate-the-ci-cd-workflow"><a href="#activate-the-ci-cd-workflow" class="header-anchor">#</a> Activate the CI/CD workflow</h2> <p>Now we have everything prepared to active the CI/CD workflow. First, checkout
the master branch, pull changes and create a new branch <code>cicd/aad-common</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> checkout master
<span class="token function">git</span> pull

<span class="token function">git</span> branch cicd/aad-common
<span class="token function">git</span> checkout cicd/aad-common

<span class="token comment"># or</span>
<span class="token function">git</span> checkout <span class="token parameter variable">-b</span> cicd/aad-common
</code></pre></div><p>There is already a Visual Studio Code workspace prepared which we can simple
open with:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> day5
code ./day5.code-workspace
</code></pre></div><p>All known application components are already available in this workspace. In
addition, we see two more directories:</p> <ul><li><strong>workflows</strong>, here we find all prepared GitHub Actions workflow for the Azure
Developer College</li> <li><strong>infrastructure</strong>, here we find all bicep modules to deploy the needed Azure
infrastructure for all components</li></ul> <h3 id="github-actions-workflows"><a href="#github-actions-workflows" class="header-anchor">#</a> GitHub Actions workflows</h3> <p>Now it's time to have a look at the already prepared GitHub Actions workflows
for Day5. You can find all workflows in the workspace folder <code>workflows</code>. Today
we focus on all workflows with the prefix <code>day5-</code>. First, we will prepare the
workflow for the shared Azure resources. Open the workflow
<code>workflows/day5-scm-common.yml</code>. This workflow, like all others, is triggered
when a pull request is opened or changes were pushed to the master branch. In
addition, filters are applied to individual files:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> day5<span class="token punctuation">-</span>scm<span class="token punctuation">-</span>common

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> day5/apps/infrastructure/bicep/common/<span class="token important">**</span>
      <span class="token punctuation">-</span> .github/workflows/day5<span class="token punctuation">-</span>scm<span class="token punctuation">-</span>common.yml
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> day5/apps/infrastructure/bicep/common/<span class="token important">**</span>
      <span class="token punctuation">-</span> .github/workflows/day5<span class="token punctuation">-</span>scm<span class="token punctuation">-</span>common.yml

  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>
</code></pre></div><p>With the trigger <code>workflow_dispatch</code>it is possible to trigger the workflow
manually.</p> <h3 id="prepare-the-workflow-and-create-a-pull-request"><a href="#prepare-the-workflow-and-create-a-pull-request" class="header-anchor">#</a> Prepare the workflow and create a pull request</h3> <p>Now it's time to prepare the workflow which rolls out the shared Azure resources
for the Azure Developer College's sample application. We have already cloned the
repository and created a new branch <code>cicd/aad-common</code>.</p> <p>Open the workflow <code>day5-scm-common.yml</code> and replace the organization name in
each job condition with your organization's name:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> github.repository == '&lt;your organisation name<span class="token punctuation">&gt;</span>/trainingdays'
  <span class="token punctuation">...</span>
  <span class="token key atrule">deploy-to-dev</span><span class="token punctuation">:</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> (github.repository == '&lt;your organisation name<span class="token punctuation">&gt;</span>/trainingdays') <span class="token important">&amp;&amp;</span> ((github.event_name == 'push') <span class="token punctuation">|</span><span class="token punctuation">|</span> (github.event_name == 'workflow_dispatch'))
  <span class="token punctuation">...</span>
  <span class="token key atrule">delpoy-to-test</span><span class="token punctuation">:</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> (github.repository == '&lt;your organisation name<span class="token punctuation">&gt;</span>/trainingdays') <span class="token important">&amp;&amp;</span> ((github.event_name == 'push') <span class="token punctuation">|</span><span class="token punctuation">|</span> (github.event_name == 'workflow_dispatch'))
</code></pre></div><p>Save the file, commit your changes and push the branch to the remote repository:</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">&quot;Change org name in common workflow&quot;</span>
<span class="token function">git</span> push --set-upstream origin cicd/aad-common
</code></pre></div><p>Now, create a pull request to merge the branch <code>cicd/aad-common</code> into the
<code>master</code> branch. Set <code>Deploy shared Azure resources for AAD integration</code> as
title.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 If you want, you can add a reviewer. However, since you as the Administrator
are excluded from the branch rules, you can merge the pull request without a
review approval.</p></div> <p>Wait a few seconds, until the status checks are triggered and successful.</p> <p>Now merge the pull request and navigate to your repository' action page. You
should see that the <code>day5-scm-common</code> workflow is triggered after a few seconds.</p> <p>After the <code>dev</code> environment is deployed, go to the Azure portal an checkout the
newly created resource group and resources. The workflow is now in the
<code>waiting</code>state, because a reviewer must approve the deployment to the <code>test</code>
environment:</p> <p>Review the pending deployment, leave a comment and <code>Approve and deploy</code>.</p> <p>Now the test environment will be deployed. After the deployment is finished, we
have another resource group with all shared Azure resources in the test
environment.</p> <h2 id="deploy-the-frontend-and-adjust-the-redirect-uris"><a href="#deploy-the-frontend-and-adjust-the-redirect-uris" class="header-anchor">#</a> Deploy the frontend and adjust the Redirect URIs</h2> <p>Now it's time to deploy the frontend and adjust the needed Redirect URIs for the
registered Azure AD applications. Azure AD issues tokens to known endpoints,
only. The frontend is hosted as a <code>Static website</code> in an Azure storage account.
As the storage account is created with a random name in the frontend deployment,
we don't know the frontend url at the moment. First we need to deploy the
frontend to each environment and then adjust the Redirect URIss in the Azure
AD's application registration for each environment.</p> <h3 id="activate-the-workflow"><a href="#activate-the-workflow" class="header-anchor">#</a> Activate the workflow</h3> <p>Let's pull the latest changes first:</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> checkout master
<span class="token function">git</span> pull
</code></pre></div><p>Next, create a new feature branch <code>cicd/aad-frontend</code>:</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> checkout <span class="token parameter variable">-b</span> cicd/aad-frontend
</code></pre></div><p>In VS Code, open the workflow <code>day5-scm-frontend.yml</code> and replace the
organization name in each job condition with your organization's name:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-bicep</span><span class="token punctuation">:</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> github.repository == '&lt;your organisation name<span class="token punctuation">&gt;</span>/trainingdays'
</code></pre></div><p>Save the file, commit your changes and push the branch to the remote repository:</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">&quot;Change org name in frontend workflow&quot;</span>
<span class="token function">git</span> push --set-upstream origin cicd/aad-frontend
</code></pre></div><p>Now, create a pull request to merge the branch <code>cicd/aad-frontend</code> into the
<code>master</code> branch. Set <code>Deploy frontend for AAD integration</code> as title.</p> <p>Wait a few seconds, until the status checks are triggered and successful.</p> <p>Now merge the pull request and navigate to your repository' action page. You
should see that the <code>day5-scm-frontend</code> workflow is triggered after a few
seconds.</p> <p>The workflow is now in the <code>waiting</code>state, because a reviewer must approve the
deployment to the <code>test</code> environment:</p> <p>Review the pending deployment, leave a comment and <code>Approve and deploy</code>.</p> <h3 id="adjust-the-redirect-uris-in-the-azure-ad-s-application-registrations"><a href="#adjust-the-redirect-uris-in-the-azure-ad-s-application-registrations" class="header-anchor">#</a> Adjust the Redirect URIs in the Azure AD's application registrations</h3> <p>After the deployment is finished, we need to adjust the Redirect URIs in the
Azure AD applications for each environment.</p> <p>Navigate to the Azure portal and go to the resource group for the development
environment. The name of the resource group starts with <code>rg-scm-devday5-</code> and
end with your GitHub organization name <code>rg-scm-devday5-&lt;your organization name&gt;</code>. We need to find the storage account where the frontend is hosted in a
static website. The deployment created some Azure <code>Tags</code> to group the used Azure
resources regarding their bounded context. Within the resource group you can set
filters in the <code>Resources</code> details view.</p> <p>Apply the following filter:</p> <p><img src="/trainingdays/assets/img/az-frontend-tag-filter.1ce6f61a.png" alt="Azure resource group filter"></p> <p>As a result we see one storage account. Open the storage account and go to the
section <code>Static website</code>. Here you can find the primary endpoint of the frontend
in the development environment. Copy the url.</p> <p>Next, navigate to <code>Azure Active Directory &gt; App registrations</code>, select <code>All applications</code> and search for <code>scmfe-dev</code>. Open the application and go to
<code>Authentication</code>. Add the <code>Redirect URIs</code> you copied to your clipboard and save
the changes:</p> <p><img src="/trainingdays/assets/img/aad-adjust-reply-url.82e67e11.png" alt="Azure AD adjust Redirect URIs"></p> <p>Please repeat these steps for the application in the <code>test</code> environment to
adjust the Redirect URIs, too.</p> <h3 id="browse-the-application"><a href="#browse-the-application" class="header-anchor">#</a> Browse the application</h3> <p>Open a private browser window and navigate to the frontend of the development
environment. If everything is configured correctly, you are redirected to Azure
AD. Log in and give the app the necessary OAuth2 permissions to access your data
on your behalf:</p> <p><img src="/trainingdays/assets/img/aad-scmfe-consent.a485e23a.png" alt="Scm Frontend consent"></p> <p>Back in the application, you see your principal name in the right upper corner:</p> <p><img src="/trainingdays/assets/img/aad-principal-name.3cd4706f.png" alt="Azure AD User's principla name"></p> <h2 id="summary"><a href="#summary" class="header-anchor">#</a> Summary</h2> <p>In this challenge we have registered four applications in Azure AD. Two
applications for the frontend and two applications for the back end. Each
frontend and backend application is assigned to one environment. We have
prepared two GitHub environments and set the necessary secrets to integrate into
Azure AD. The shared Azure resources and the frontend are already deployed to
the <code>dev</code>and <code>test</code>environment. Next, we go into the breakout session and roll
out the complete application.</p> <p><a href="/trainingdays/day5/challenges/02-challenge.html">◀ Previous challenge</a> | <a href="/trainingdays/day5/" class="router-link-active">🔼 Day 5</a> | <a href="/trainingdays/day5/challenges/04-breakout.html">Next challenge ▶</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day5/challenges/03-challenge.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.b4a8c541.js" defer></script><script src="/trainingdays/assets/js/3.da874b83.js" defer></script><script src="/trainingdays/assets/js/33.39efcbb5.js" defer></script>
  </body>
</html>
